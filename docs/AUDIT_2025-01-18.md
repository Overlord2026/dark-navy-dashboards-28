# Family Office Marketplace - Full Audit & NIL Remnant Sweep
**Date:** 2025-01-18  
**Type:** READ-ONLY SCAN  
**Purpose:** Definitive audit for ChatGPT context with NIL cleanup checklist

## Canon Documentation Links
- âœ… [PROJECT_CANON.md](./PROJECT_CANON.md) - Comprehensive application structure
- âœ… [PROJECT_INDEX.json](./PROJECT_INDEX.json) - Machine-readable project index  
- âœ… [REPO_MAP.md](./REPO_MAP.md) - External module mapping
- âœ… [MVP_PLAN_SUMMARY.md](./MVP_PLAN_SUMMARY.md) - MVP readiness and planning
- âœ… [MVP_BRIEF_TEAM.md](./MVP_BRIEF_TEAM.md) - Executive MVP brief
- âœ… [docs/_lovable/patch-log.md](./docs/_lovable/patch-log.md) - Development changes log

## What This App Is

**Family Office Marketplace** is a comprehensive financial services platform connecting families with their professional service providers (advisors, CPAs, attorneys, insurance professionals) in unified workspaces. The platform enables:

- **Advisors** to manage clients, generate reports, track ROI, and invite families into shared workspaces
- **Families** to access financial tools, collaborate with their professional team, and manage wealth across segments (aspiring vs. retirees)
- **Professional Services** marketplace connecting families with vetted CPAs, attorneys, and insurance professionals
- **Shared Financial Tools** including Goals, Transactions, Cash Flow, Reports, Accounts, Budgets, Investments, and Advisory services
- **Audit-ready compliance** with receipt generation, blockchain anchoring, and comprehensive activity logging

**Core Workflow:** Advisor invites Family â†’ Shared workspace with financial tools â†’ Professional services marketplace integration â†’ Audit trail and compliance reporting.

## Current Module/Prefix Map

| Module (internal)   | Lovable Project Name             | GitHub Repo URL                                                     | Subtree prefix                   |
|---------------------|----------------------------------|----------------------------------------------------------------------|----------------------------------|
| advisor-platform    | Advisor Lead Alchemy             | https://github.com/Overlord2026/advisor-lead-alchemy                | packages/advisor-platform        |
| tax-tools           | Neptune React Orbit (Advanced Tax)| https://github.com/Overlord2026/neptune-react-orbit                 | packages/tax-tools               |
| marketplace         | Wealth Connect Marketplace       | https://github.com/Overlord2026/lovable-wealth-connect              | packages/marketplace             |

> *Internal prefixes are canonical. If repo URLs change, update this table and the git remote; the prefixes stay stable.*

## Route & Surface Map

| Route | Component | Persona Gate | Status |
|-------|-----------|--------------|--------|
| `/` | `HomePage` (TabPages) | Public | âœ… Implemented |
| `/auth` | `AuthPage` | Public | âœ… Implemented |
| `/auth/callback` | `AuthCallback` | Public | âœ… Implemented |
| `/onboarding` | `OnboardingPage` | Authenticated | âœ… Implemented |
| `/start/families` | `FamilyOnboarding` | Public | âœ… Implemented |
| `/family/home` | `FamilyHomePage` | Family | âœ… Implemented |
| `/pros/advisors` | `AdvisorsLayout` | Advisor | âœ… Implemented |
| `/pros/advisors/home` | `AdvisorHomePage` | Advisor | âœ… Implemented |
| `/pros/advisors/leads` | `AdvisorLeadsPage` | Advisor | âœ… Implemented |
| `/pros/advisors/meetings` | `AdvisorMeetingsPage` | Advisor | âœ… Implemented |
| `/pros/advisors/campaigns` | `AdvisorCampaignsPage` | Advisor | âœ… Implemented |
| `/pros/advisors/pipeline` | `AdvisorPipelinePage` | Advisor | âœ… Implemented |
| `/pros/advisors/tools` | `AdvisorToolsPage` | Advisor | âœ… Implemented |
| `/pros/accountants` | `AccountantsDashboard` | CPA | âœ… Implemented |
| `/pros/accountants/documents` | `DocumentsReview` | CPA | âœ… Implemented |
| `/pros/accountants/exports` | `CSVExport` | CPA | âœ… Implemented |
| `/pros/attorneys` | `AttorneysDashboard` | Attorney | âœ… Implemented |
| `/pros/attorneys/entities` | `EntitiesAndTrusts` | Attorney | âœ… Implemented |
| `/pros/attorneys/vault` | `EstateVault` | Attorney | âœ… Implemented |
| `/insurance/home` | `InsuranceHomePage` | Insurance | âœ… Implemented |
| `/insurance/meetings` | `InsuranceMeetingsPage` | Insurance | âœ… Implemented |
| `/insurance/pipeline` | `InsurancePipelinePage` | Insurance | âœ… Implemented |
| `/insurance/proof` | `InsuranceProofPage` | Insurance | âœ… Implemented |
| `/marketplace` | `MarketplaceIndex` | Public | âœ… Implemented |
| `/marketplace/advisors` | `MarketplaceAdvisors` | Public | âœ… Implemented |
| `/marketplace/cpa` | `CPAIndex` | Public | âœ… Implemented |
| `/marketplace/attorneys` | `AttorneyMarketplace` | Public | âœ… Implemented |
| `/marketplace/insurance` | `MarketplaceInsurance` | Public | âœ… Implemented |
| `/tools/retirement-roadmap` | `RetirementRoadmapTool` | Family | âœ… Implemented |
| `/tools/rmd-check` | `RMDCheckTool` | Family | âœ… Implemented |
| `/tools/social-security` | `SocialSecurityTool` | Family | âœ… Implemented |
| `/tools/wealth-vault` | `VaultPage` | Family | âœ… Implemented |
| `/tools/estate-planner` | `EstateToolPage` | Family | âœ… Implemented |
| `/tax/*` | `TaxShell` + calculators | Pro/Family | âœ… Implemented |
| `/invite/:token` | `InvitePage` | Public | âœ… Implemented |
| `/admin/ready-check` | `ReadyCheck` | Admin | âœ… Implemented |

### Advisor Platform Nested Routes (packages/advisor-platform)
| Route | Component | Status |
|-------|-----------|--------|
| `/advisors/dashboard` | `AdvisorPlatformDashboard` | âœ… Complete |
| `/advisors/prospects` | `ProspectsPage` | âœ… Complete |
| `/advisors/roi-tracker` | `ROITrackerPage` | âœ… Complete |
| `/advisors/calendar` | `CalendarPage` | âœ… Complete |
| `/advisors/settings` | `SettingsPage` | âœ… Complete |
| `/advisors/recordings` | `RecordingsPage` | âœ… Complete |
| `/advisors/questionnaires` | `QuestionnairesPage` | âœ… Complete |
| `/advisors/templates` | `TemplatesPage` | âœ… Complete |

## Persona & Nav Matrix

| Persona | Key Pages/Tools | Feature Flags |
|---------|----------------|---------------|
| **Families** | Home, Tools Hub, Goals, Transactions, Cash Flow, Retirement Roadmap, RMD Check, Social Security, Wealth Vault | `FAM_V1`, `IA_V2` |
| **Advisors** | Home, Leads, Meetings, Campaigns, Pipeline, Tools (incl. Platform Dashboard, Prospects, ROI Tracker) | `ADV_V1`, `IA_V2` |
| **CPAs/Accountants** | Dashboard, Documents Review, CSV Export, Tax Tools | `IA_V2` |
| **Attorneys** | Dashboard, Entities & Trusts, Estate Vault | `IA_V2` |
| **Insurance** | Home, Meetings, Pipeline, Proof of Work | `IA_V2` |
| **Marketplace** | Advisor listings, CPA directory, Attorney directory, Insurance professionals | `PUBLIC_CATALOG_ENABLED` |

### NIL/Creator-App Personas (Candidate for Removal)
| Persona | Configuration | Status |
|---------|---------------|--------|
| `nil-athlete` | NIL â€” Athlete/Parent workspace | ðŸ”´ **REMOVE** |
| `nil-school` | NIL â€” School/Brand workspace | ðŸ”´ **REMOVE** |
| `nil-brand` | NIL â€” Brands & Local Businesses | ðŸ”´ **REMOVE** |

## NIL Remnant Sweep â€” Code Analysis

**Total Matches Found:** 2,870 matches across 271 files

### Counts by Folder
| Folder | Files | Matches |
|--------|-------|---------|
| `src/lib/nil/` | 15 files | 450+ matches |
| `src/features/nil/` | 23 files | 380+ matches |
| `src/pages/nil/` | 18 files | 340+ matches |
| `src/components/nil/` | 12 files | 290+ matches |
| `src/config/` | 8 files | 45 matches (nilFeatureFlags.ts, nilTools.json, etc.) |
| `src/hooks/` | 5 files | 32 matches (useNILAccess.ts) |
| Documentation | 25 files | 850+ matches |
| Supabase migrations | 16 files | 274+ matches |
| Edge functions | 5 files | 120+ matches |

### Top Code Offenders (Shortlist)
1. `src/lib/nil/analytics.ts` - 203 lines of NIL analytics tracking
2. `src/config/personaConfig.ts` - NIL personas in configuration  
3. `src/routes.tsx` - NIL route definitions (commented as "removed")
4. `NIL_MIGRATION_PLAN.md` - 170+ line migration strategy document
5. `supabase/migrations/20250811181344_*.sql` - Complete NIL database schema

## NIL Remnant Sweep â€” Database (Migrations)

### NIL Tables in Database
Based on migration `20250811181344_25dbb0f2-12b6-49cc-b351-17b257811f5b.sql`:

**Core Tables:**
- `nil_parties` - Athletes, brands, agencies, institutions, advisors
- `nil_eligibility` - Athlete eligibility status tracking
- `nil_deals` - Deal/contract management between athletes and brands
- `nil_deliverables` - Content deliverables and submission tracking
- `nil_events` - Audit trail for NIL activities
- `nil_payouts` - Payment processing and status
- `nil_compliance_snapshots` - Compliance state snapshots

**Custom Types:**
- `nil_party_type` ENUM ('athlete', 'brand', 'agency', 'institution', 'advisor')
- `nil_eligibility_status` ENUM ('eligible', 'ineligible', 'pending', 'suspended')
- `nil_deal_status` ENUM ('draft', 'active', 'completed', 'cancelled', 'disputed')
- `nil_deliverable_status` ENUM ('pending', 'in_progress', 'submitted', 'approved', 'rejected')
- `nil_event_type` ENUM ('content_upload', 'authenticity_verification', 'compliance_check', 'payout_processed')
- `nil_payout_status` ENUM ('pending', 'processing', 'completed', 'failed', 'disputed')

**Indexes & RLS:**
- 16 indexes on NIL tables for performance
- Full RLS (Row Level Security) enabled on all NIL tables
- Tenant isolation policies implemented

**Storage Buckets:**
- Evidence suggests NIL-specific storage buckets for content and compliance documents

## Env & Feature Flags

### NIL-Related Feature Flags
From `src/lib/flags.ts`:

| Flag | Description | Status |
|------|-------------|--------|
| `NIL_PUBLIC_ENABLED` | Show /nil and /nil/index for unauthenticated users | ðŸ”´ **REMOVE** |
| `NIL_AGENT_ENABLED` | Enable NIL agent portal and functionality | ðŸ”´ **REMOVE** |
| `NIL_SCHOOL_ENABLED` | Enable NIL school portal and functionality | ðŸ”´ **REMOVE** |
| `BRAND_PUBLIC_ENABLED` | Enable brand and local business NIL onboarding | ðŸ”´ **REMOVE** |

### Referenced Code Paths
- `src/config/nilFeatureFlags.ts` - NIL-specific feature toggles
- `src/config/nilTools.json` - NIL workspace configuration  
- `src/data/nilEntitlements.ts` - NIL subscription tiers
- `src/hooks/useNILAccess.ts` - NIL access control logic
- `fixtures/fixtures.nil.ts` - NIL demo data

## Wireframe Recap

### Site Map (Indented List)
```
Family Office Marketplace
â”œâ”€â”€ Public Landing (/)
â”œâ”€â”€ Authentication (/auth, /auth/callback)
â”œâ”€â”€ Onboarding Flows
â”‚   â”œâ”€â”€ General (/onboarding)
â”‚   â”œâ”€â”€ Family (/start/families)
â”‚   â””â”€â”€ Professional (various /start/* routes)
â”œâ”€â”€ Professional Workspaces
â”‚   â”œâ”€â”€ Advisors (/pros/advisors/*)
â”‚   â”‚   â”œâ”€â”€ Home, Leads, Meetings, Campaigns, Pipeline, Tools
â”‚   â”‚   â””â”€â”€ Platform (Dashboard, Prospects, ROI, Calendar, Settings)
â”‚   â”œâ”€â”€ CPAs (/pros/accountants/*)
â”‚   â”‚   â””â”€â”€ Dashboard, Documents, Exports
â”‚   â”œâ”€â”€ Attorneys (/pros/attorneys/*)
â”‚   â”‚   â””â”€â”€ Dashboard, Entities & Trusts, Vault
â”‚   â””â”€â”€ Insurance (/insurance/*)
â”‚       â””â”€â”€ Home, Meetings, Pipeline, Proof
â”œâ”€â”€ Family Workspaces
â”‚   â”œâ”€â”€ Family Home (/family/home)
â”‚   â””â”€â”€ Financial Tools (/tools/*)
â”‚       â”œâ”€â”€ Retirement Roadmap, RMD Check, Social Security
â”‚       â””â”€â”€ Wealth Vault, Estate Planner
â”œâ”€â”€ Shared Financial Tools
â”‚   â”œâ”€â”€ Goals, Transactions, Cash Flow
â”‚   â”œâ”€â”€ Reports, Accounts, Budgets
â”‚   â””â”€â”€ Investments, Advice
â”œâ”€â”€ Marketplace (/marketplace/*)
â”‚   â”œâ”€â”€ Advisor Directory
â”‚   â”œâ”€â”€ CPA Directory  
â”‚   â”œâ”€â”€ Attorney Directory
â”‚   â””â”€â”€ Insurance Professionals
â”œâ”€â”€ Tax Planning Suite (/tax/*)
â”‚   â””â”€â”€ 10+ specialized tax calculators
â””â”€â”€ Administrative
    â”œâ”€â”€ Settings, Profile
    â””â”€â”€ Admin Tools (/admin/*)
```

### Swimlane Text Sketch

**Families Swimlane:**
`Landing â†’ Auth â†’ Family Onboarding â†’ Family Home â†’ Financial Tools (Goals, Transactions, Cash Flow, Retirement Planning) â†’ Marketplace (find professionals) â†’ Shared Workspace (with advisor)`

**Advisors Swimlane:**  
`Landing â†’ Auth â†’ Advisor Onboarding â†’ Advisor Home â†’ Client Management (Leads, Meetings, Pipeline) â†’ Advisor Platform (Prospects, ROI Tracker) â†’ Invite Family â†’ Shared Workspace â†’ Reports & Analytics`

**Accountants Swimlane:**
`Landing â†’ Auth â†’ Professional Onboarding â†’ CPA Dashboard â†’ Document Review â†’ CSV Export â†’ Tax Tools â†’ Client Collaboration`

**Attorneys Swimlane:**
`Landing â†’ Auth â†’ Professional Onboarding â†’ Attorney Dashboard â†’ Entities & Trusts Management â†’ Estate Vault â†’ Legal Document Collaboration`

**Marketplace Swimlane:**
`Public Marketplace â†’ Professional Directory â†’ Profile View â†’ Contact/Quote â†’ Onboarding â†’ Workspace Integration`

## P0 Cleanup Checklist

### NIL Removal/Isolation
- [ ] **Remove NIL routes/components** - Clean up `src/routes.tsx`, remove NIL page components
- [ ] **Remove NIL personas** - Update `src/config/personaConfig.ts`, remove nil-athlete, nil-school, nil-brand
- [ ] **Remove NIL feature flags** - Clean up `src/lib/flags.ts`, remove NIL_*_ENABLED flags
- [ ] **Quarantine NIL database** - Archive NIL migration files, document table removal process
- [ ] **Remove NIL edge functions** - Clean up Supabase functions directory
- [ ] **Clean NIL configuration** - Remove nilFeatureFlags.ts, nilTools.json, nilEntitlements.ts
- [ ] **Remove NIL hooks/utils** - Clean up useNILAccess.ts and related utilities
- [ ] **Clean NIL analytics** - Remove src/lib/nil/analytics.ts (203 lines)

### Core Platform Verification  
- [ ] **Verify Advisor â†’ Family bidirectional invites** - Test magic link invitation flow end-to-end
- [ ] **Ensure Accountants & Attorneys hubs clickable** - Verify professional workspace navigation
- [ ] **Confirm Marketplace shell clickable** - Test marketplace directory and professional profiles
- [ ] **Verify shared financial tools** - Test Goals, Transactions, Cash Flow across personas
- [ ] **Test authentication flows** - OAuth, magic links, onboarding paths

### Technical Cleanup
- [ ] **Fix navigation fragmentation** - Consolidate SecondaryNav, implement unified sidebar
- [ ] **Resolve route conflicts** - Clean up duplicate routes in src/routes.tsx
- [ ] **Service worker safety** - Add NODE_ENV checks for development
- [ ] **Console log cleanup** - Implement build-time log stripping (3,156+ statements)
- [ ] **React duplication check** - Verify single React instance in bundle

### UI Polish
- [ ] **Implement unified design system** - Consistent typography, colors, spacing
- [ ] **Fix missing empty states** - Add proper empty states for Reports, Accounts tools
- [ ] **Improve mobile responsiveness** - Test advisor tab layout on mobile devices
- [ ] **Add loading states** - Implement consistent loading patterns across tools
- [ ] **Accessibility improvements** - Add ARIA labels, keyboard navigation, focus management

### Documentation & Patch Log
- [ ] **Update patch log** - Document all NIL removal and platform improvements
- [ ] **Update route documentation** - Reflect final route structure in PROJECT_CANON.md
- [ ] **Clean up documentation** - Remove NIL references from all docs
- [ ] **Update README** - Reflect final platform scope and capabilities

## Open Questions

*This section is intentionally left empty for future audit findings and clarification needs.*

---

**Generated:** 2025-01-18  
**Total Routes Analyzed:** 35+ active routes  
**Total NIL Matches:** 2,870+ across 271 files  
**Database Tables:** 7 NIL tables + 6 custom types  
**Cleanup Priority:** P0 (blocks clean production deployment)